"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConsoleCommand = void 0;
const repl_1 = require("repl");
const command_1 = require("@oclif/command");
const liskClient = require("@liskhq/lisk-client");
class ConsoleCommand extends command_1.default {
    async run() {
        const { flags } = this.parse(ConsoleCommand);
        this.log('Entering Lisk REPL: type `Ctrl+C` or `.exit` to exit');
        const options = { prompt: `${this.config.pjson.name} > ` };
        const replServer = repl_1.start(options);
        await this.initREPLContext(replServer, flags);
        replServer.on('reset', async () => {
            this.log('Initializing repl context after reset!');
            await this.initREPLContext(replServer, flags);
        });
        replServer.on('exit', () => {
            this.log('Received "exit" event from lisk!');
            process.exit();
        });
    }
    async initREPLContext(replServer, flags) {
        const clientLibraries = liskClient;
        Object.keys(clientLibraries).forEach(key => {
            if (key.toLowerCase() !== 'buffer') {
                Object.defineProperty(replServer.context, key, {
                    enumerable: true,
                    value: clientLibraries[key],
                });
            }
        });
        if (flags['api-ipc']) {
            const ipcClient = await liskClient.apiClient.createIPCClient(flags['api-ipc']);
            Object.defineProperty(replServer.context, 'client', {
                enumerable: true,
                value: ipcClient,
            });
        }
        if (flags['api-ws']) {
            const wsClient = await liskClient.apiClient.createWSClient(flags['api-ws']);
            Object.defineProperty(replServer.context, 'client', {
                enumerable: true,
                value: wsClient,
            });
        }
    }
}
exports.ConsoleCommand = ConsoleCommand;
ConsoleCommand.description = 'Lisk interactive REPL session to run commands.';
ConsoleCommand.examples = [
    'console',
    'console --api-ws=ws://localhost:8080',
    'console --api-ipc=/path/to/server',
];
ConsoleCommand.flags = {
    'api-ipc': command_1.flags.string({
        description: 'Enable api-client with IPC communication.',
        exclusive: ['api-ws'],
    }),
    'api-ws': command_1.flags.string({
        description: 'Enable api-client with Websocket communication.',
        exclusive: ['api-ipc'],
    }),
};
//# sourceMappingURL=console.js.map