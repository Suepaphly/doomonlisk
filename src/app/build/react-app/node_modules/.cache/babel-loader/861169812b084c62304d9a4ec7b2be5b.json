{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/regenerator\");\n\nvar _asyncToGenerator = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nvar _objectSpread = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/helpers/objectSpread2\");\n\nvar _classCallCheck = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ConsensusStateStore = void 0;\n\nvar constants_1 = require(\"../data_access/constants\");\n\nvar constants_2 = require(\"../constants\");\n\nvar ConsensusStateStore = /*#__PURE__*/function () {\n  function ConsensusStateStore(dataAccess) {\n    _classCallCheck(this, ConsensusStateStore);\n\n    this._name = 'ConsensusState';\n    this._dataAccess = dataAccess;\n    this._data = {};\n    this._originalData = {};\n    this._initialValue = {};\n    this._updatedKeys = new Set();\n    this._originalUpdatedKeys = new Set();\n  }\n\n  _createClass(ConsensusStateStore, [{\n    key: \"createSnapshot\",\n    value: function createSnapshot() {\n      this._originalData = _objectSpread({}, this._data);\n      this._originalUpdatedKeys = new Set(this._updatedKeys);\n    }\n  }, {\n    key: \"restoreSnapshot\",\n    value: function restoreSnapshot() {\n      this._data = _objectSpread({}, this._originalData);\n      this._updatedKeys = new Set(this._originalUpdatedKeys);\n    }\n  }, {\n    key: \"get\",\n    value: function () {\n      var _get = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(key) {\n        var value, dbValue;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                value = this._data[key];\n\n                if (!value) {\n                  _context.next = 3;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", value);\n\n              case 3:\n                _context.next = 5;\n                return this._dataAccess.getConsensusState(key);\n\n              case 5:\n                dbValue = _context.sent;\n\n                if (!(dbValue === undefined)) {\n                  _context.next = 8;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", dbValue);\n\n              case 8:\n                if (key !== constants_2.CONSENSUS_STATE_FINALIZED_HEIGHT_KEY) {\n                  this._initialValue[key] = dbValue;\n                }\n\n                this._data[key] = dbValue;\n                return _context.abrupt(\"return\", this._data[key]);\n\n              case 11:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function get(_x) {\n        return _get.apply(this, arguments);\n      }\n\n      return get;\n    }()\n  }, {\n    key: \"getOrDefault\",\n    value: function getOrDefault() {\n      throw new Error(\"getOrDefault cannot be called for \".concat(this._name));\n    }\n  }, {\n    key: \"find\",\n    value: function find() {\n      throw new Error(\"getOrDefault cannot be called for \".concat(this._name));\n    }\n  }, {\n    key: \"set\",\n    value: function () {\n      var _set = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(key, value) {\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                this._data[key] = value;\n\n                this._updatedKeys.add(key);\n\n              case 2:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function set(_x2, _x3) {\n        return _set.apply(this, arguments);\n      }\n\n      return set;\n    }()\n  }, {\n    key: \"finalize\",\n    value: function finalize(batch) {\n      var stateDiff = {\n        updated: [],\n        created: [],\n        deleted: []\n      };\n\n      if (this._updatedKeys.size === 0) {\n        return stateDiff;\n      }\n\n      for (var _i = 0, _Array$from = Array.from(this._updatedKeys); _i < _Array$from.length; _i++) {\n        var key = _Array$from[_i];\n        var dbKey = \"\".concat(constants_1.DB_KEY_CONSENSUS_STATE, \":\").concat(key);\n        var updatedValue = this._data[key];\n        batch.put(dbKey, updatedValue);\n\n        if (key === constants_2.CONSENSUS_STATE_FINALIZED_HEIGHT_KEY) {\n          continue;\n        }\n\n        var initialValue = this._initialValue[key];\n\n        if (initialValue !== undefined && !initialValue.equals(updatedValue)) {\n          stateDiff.updated.push({\n            key: dbKey,\n            value: initialValue\n          });\n        } else if (initialValue === undefined) {\n          stateDiff.created.push(dbKey);\n        }\n      }\n\n      return stateDiff;\n    }\n  }]);\n\n  return ConsensusStateStore;\n}();\n\nexports.ConsensusStateStore = ConsensusStateStore;","map":{"version":3,"sources":["../../src/state_store/consensus_state_store.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.ConsensusStateStore = void 0;\nconst constants_1 = require(\"../data_access/constants\");\nconst constants_2 = require(\"../constants\");\nclass ConsensusStateStore {\n    constructor(dataAccess) {\n        this._name = 'ConsensusState';\n        this._dataAccess = dataAccess;\n        this._data = {};\n        this._originalData = {};\n        this._initialValue = {};\n        this._updatedKeys = new Set();\n        this._originalUpdatedKeys = new Set();\n    }\n    createSnapshot() {\n        this._originalData = { ...this._data };\n        this._originalUpdatedKeys = new Set(this._updatedKeys);\n    }\n    restoreSnapshot() {\n        this._data = { ...this._originalData };\n        this._updatedKeys = new Set(this._originalUpdatedKeys);\n    }\n    async get(key) {\n        const value = this._data[key];\n        if (value) {\n            return value;\n        }\n        const dbValue = await this._dataAccess.getConsensusState(key);\n        if (dbValue === undefined) {\n            return dbValue;\n        }\n        if (key !== constants_2.CONSENSUS_STATE_FINALIZED_HEIGHT_KEY) {\n            this._initialValue[key] = dbValue;\n        }\n        this._data[key] = dbValue;\n        return this._data[key];\n    }\n    getOrDefault() {\n        throw new Error(`getOrDefault cannot be called for ${this._name}`);\n    }\n    find() {\n        throw new Error(`getOrDefault cannot be called for ${this._name}`);\n    }\n    async set(key, value) {\n        this._data[key] = value;\n        this._updatedKeys.add(key);\n    }\n    finalize(batch) {\n        const stateDiff = { updated: [], created: [], deleted: [] };\n        if (this._updatedKeys.size === 0) {\n            return stateDiff;\n        }\n        for (const key of Array.from(this._updatedKeys)) {\n            const dbKey = `${constants_1.DB_KEY_CONSENSUS_STATE}:${key}`;\n            const updatedValue = this._data[key];\n            batch.put(dbKey, updatedValue);\n            if (key === constants_2.CONSENSUS_STATE_FINALIZED_HEIGHT_KEY) {\n                continue;\n            }\n            const initialValue = this._initialValue[key];\n            if (initialValue !== undefined && !initialValue.equals(updatedValue)) {\n                stateDiff.updated.push({\n                    key: dbKey,\n                    value: initialValue,\n                });\n            }\n            else if (initialValue === undefined) {\n                stateDiff.created.push(dbKey);\n            }\n        }\n        return stateDiff;\n    }\n}\nexports.ConsensusStateStore = ConsensusStateStore;\n//# sourceMappingURL=consensus_state_store.js.map"]},"metadata":{},"sourceType":"script"}