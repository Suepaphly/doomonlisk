{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/regenerator\");\n\nvar _toConsumableArray = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/helpers/toConsumableArray\");\n\nvar _asyncToGenerator = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nvar _createForOfIteratorHelper = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/helpers/createForOfIteratorHelper\");\n\nvar _classCallCheck = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar _inherits = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/helpers/inherits\");\n\nvar _createSuper = require(\"/home/lisk/doomonlisk/src/app/build/react-app/node_modules/@babel/runtime/helpers/createSuper\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.UnlockTransactionAsset = void 0;\n\nvar base_asset_1 = require(\"../../base_asset\");\n\nvar errors_1 = require(\"../../../errors\");\n\nvar constants_1 = require(\"../constants\");\n\nvar utils_1 = require(\"../utils\");\n\nvar UnlockTransactionAsset = /*#__PURE__*/function (_base_asset_1$BaseAss) {\n  _inherits(UnlockTransactionAsset, _base_asset_1$BaseAss);\n\n  var _super = _createSuper(UnlockTransactionAsset);\n\n  function UnlockTransactionAsset(unlockFixHeight) {\n    var _this;\n\n    _classCallCheck(this, UnlockTransactionAsset);\n\n    _this = _super.call(this);\n    _this.name = 'unlockToken';\n    _this.id = 2;\n    _this.schema = {\n      $id: 'lisk/dpos/unlock',\n      type: 'object',\n      required: ['unlockObjects'],\n      properties: {\n        unlockObjects: {\n          type: 'array',\n          minItems: 1,\n          maxItems: 20,\n          items: {\n            type: 'object',\n            required: ['delegateAddress', 'amount', 'unvoteHeight'],\n            properties: {\n              delegateAddress: {\n                dataType: 'bytes',\n                fieldNumber: 1,\n                minLength: 20,\n                maxLength: 20\n              },\n              amount: {\n                dataType: 'uint64',\n                fieldNumber: 2\n              },\n              unvoteHeight: {\n                dataType: 'uint32',\n                fieldNumber: 3\n              }\n            }\n          },\n          fieldNumber: 1\n        }\n      }\n    };\n    _this._unlockFixHeight = unlockFixHeight !== null && unlockFixHeight !== void 0 ? unlockFixHeight : 0;\n    return _this;\n  }\n\n  _createClass(UnlockTransactionAsset, [{\n    key: \"validate\",\n    value: function validate(_ref) {\n      var asset = _ref.asset;\n\n      var _iterator = _createForOfIteratorHelper(asset.unlockObjects),\n          _step;\n\n      try {\n        for (_iterator.s(); !(_step = _iterator.n()).done;) {\n          var unlock = _step.value;\n\n          if (unlock.unvoteHeight <= 0) {\n            throw new errors_1.ValidationError('Height cannot be less than or equal to zero', unlock.unvoteHeight.toString());\n          }\n\n          if (unlock.amount <= BigInt(0)) {\n            throw new errors_1.ValidationError('Amount cannot be less than or equal to zero.', unlock.amount.toString());\n          }\n\n          if (unlock.amount % constants_1.AMOUNT_MULTIPLIER_FOR_VOTES !== BigInt(0)) {\n            throw new errors_1.ValidationError('Amount should be multiple of 10 * 10^8.', unlock.amount.toString());\n          }\n        }\n      } catch (err) {\n        _iterator.e(err);\n      } finally {\n        _iterator.f();\n      }\n    }\n  }, {\n    key: \"apply\",\n    value: function () {\n      var _apply = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(_ref2) {\n        var _this2 = this;\n\n        var asset, transaction, store, reducerHandler, _iterator2, _step2, _loop;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                asset = _ref2.asset, transaction = _ref2.transaction, store = _ref2.stateStore, reducerHandler = _ref2.reducerHandler;\n                _iterator2 = _createForOfIteratorHelper(asset.unlockObjects);\n                _context2.prev = 2;\n                _loop = /*#__PURE__*/_regeneratorRuntime.mark(function _loop() {\n                  var unlock, sender, delegate, unlockIndex, currentHeight, minWaitingHeight, minUnlockDelay, lastPomHeight;\n                  return _regeneratorRuntime.wrap(function _loop$(_context) {\n                    while (1) {\n                      switch (_context.prev = _context.next) {\n                        case 0:\n                          unlock = _step2.value;\n                          _context.next = 3;\n                          return store.account.get(transaction.senderAddress);\n\n                        case 3:\n                          sender = _context.sent;\n                          _context.next = 6;\n                          return store.account.get(unlock.delegateAddress);\n\n                        case 6:\n                          delegate = _context.sent;\n\n                          if (!(delegate.dpos.delegate.username === '')) {\n                            _context.next = 9;\n                            break;\n                          }\n\n                          throw new Error('Voted account is not registered as delegate.');\n\n                        case 9:\n                          unlockIndex = sender.dpos.unlocking.findIndex(function (obj) {\n                            return obj.amount === unlock.amount && obj.delegateAddress.equals(unlock.delegateAddress) && obj.unvoteHeight === unlock.unvoteHeight;\n                          });\n\n                          if (!(unlockIndex < 0)) {\n                            _context.next = 12;\n                            break;\n                          }\n\n                          throw new Error('Corresponding unlocking object not found.');\n\n                        case 12:\n                          currentHeight = store.chain.lastBlockHeaders[0].height + 1;\n                          minWaitingHeight = utils_1.getMinWaitingHeight(sender.address, delegate.address, unlock);\n\n                          if (!(minWaitingHeight > currentHeight)) {\n                            _context.next = 16;\n                            break;\n                          }\n\n                          throw new Error('Unlocking is not permitted as it is still within the waiting period.');\n\n                        case 16:\n                          minUnlockDelay = utils_1.getMinPunishedHeight(sender, delegate);\n                          lastPomHeight = delegate.dpos.delegate.pomHeights.length === 0 ? undefined : Math.max.apply(Math, _toConsumableArray(delegate.dpos.delegate.pomHeights));\n\n                          if (!(currentHeight >= _this2._unlockFixHeight && minUnlockDelay > currentHeight && lastPomHeight !== undefined && lastPomHeight < minWaitingHeight)) {\n                            _context.next = 20;\n                            break;\n                          }\n\n                          throw new Error('Unlocking is not permitted as the delegate is currently being punished.');\n\n                        case 20:\n                          if (!(currentHeight < _this2._unlockFixHeight && minUnlockDelay > currentHeight)) {\n                            _context.next = 22;\n                            break;\n                          }\n\n                          throw new Error('Unlocking is not permitted as the delegate is currently being punished.');\n\n                        case 22:\n                          sender.dpos.unlocking.splice(unlockIndex, 1);\n                          _context.next = 25;\n                          return reducerHandler.invoke('token:credit', {\n                            address: transaction.senderAddress,\n                            amount: unlock.amount\n                          });\n\n                        case 25:\n                          _context.next = 27;\n                          return store.account.set(sender.address, sender);\n\n                        case 27:\n                        case \"end\":\n                          return _context.stop();\n                      }\n                    }\n                  }, _loop);\n                });\n\n                _iterator2.s();\n\n              case 5:\n                if ((_step2 = _iterator2.n()).done) {\n                  _context2.next = 9;\n                  break;\n                }\n\n                return _context2.delegateYield(_loop(), \"t0\", 7);\n\n              case 7:\n                _context2.next = 5;\n                break;\n\n              case 9:\n                _context2.next = 14;\n                break;\n\n              case 11:\n                _context2.prev = 11;\n                _context2.t1 = _context2[\"catch\"](2);\n\n                _iterator2.e(_context2.t1);\n\n              case 14:\n                _context2.prev = 14;\n\n                _iterator2.f();\n\n                return _context2.finish(14);\n\n              case 17:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee, null, [[2, 11, 14, 17]]);\n      }));\n\n      function apply(_x) {\n        return _apply.apply(this, arguments);\n      }\n\n      return apply;\n    }()\n  }]);\n\n  return UnlockTransactionAsset;\n}(base_asset_1.BaseAsset);\n\nexports.UnlockTransactionAsset = UnlockTransactionAsset;","map":{"version":3,"sources":["../../../../src/modules/dpos/transaction_assets/unlock_transaction_asset.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.UnlockTransactionAsset = void 0;\nconst base_asset_1 = require(\"../../base_asset\");\nconst errors_1 = require(\"../../../errors\");\nconst constants_1 = require(\"../constants\");\nconst utils_1 = require(\"../utils\");\nclass UnlockTransactionAsset extends base_asset_1.BaseAsset {\n    constructor(unlockFixHeight) {\n        super();\n        this.name = 'unlockToken';\n        this.id = 2;\n        this.schema = {\n            $id: 'lisk/dpos/unlock',\n            type: 'object',\n            required: ['unlockObjects'],\n            properties: {\n                unlockObjects: {\n                    type: 'array',\n                    minItems: 1,\n                    maxItems: 20,\n                    items: {\n                        type: 'object',\n                        required: ['delegateAddress', 'amount', 'unvoteHeight'],\n                        properties: {\n                            delegateAddress: {\n                                dataType: 'bytes',\n                                fieldNumber: 1,\n                                minLength: 20,\n                                maxLength: 20,\n                            },\n                            amount: {\n                                dataType: 'uint64',\n                                fieldNumber: 2,\n                            },\n                            unvoteHeight: {\n                                dataType: 'uint32',\n                                fieldNumber: 3,\n                            },\n                        },\n                    },\n                    fieldNumber: 1,\n                },\n            },\n        };\n        this._unlockFixHeight = unlockFixHeight !== null && unlockFixHeight !== void 0 ? unlockFixHeight : 0;\n    }\n    validate({ asset }) {\n        for (const unlock of asset.unlockObjects) {\n            if (unlock.unvoteHeight <= 0) {\n                throw new errors_1.ValidationError('Height cannot be less than or equal to zero', unlock.unvoteHeight.toString());\n            }\n            if (unlock.amount <= BigInt(0)) {\n                throw new errors_1.ValidationError('Amount cannot be less than or equal to zero.', unlock.amount.toString());\n            }\n            if (unlock.amount % constants_1.AMOUNT_MULTIPLIER_FOR_VOTES !== BigInt(0)) {\n                throw new errors_1.ValidationError('Amount should be multiple of 10 * 10^8.', unlock.amount.toString());\n            }\n        }\n    }\n    async apply({ asset, transaction, stateStore: store, reducerHandler, }) {\n        for (const unlock of asset.unlockObjects) {\n            const sender = await store.account.get(transaction.senderAddress);\n            const delegate = await store.account.get(unlock.delegateAddress);\n            if (delegate.dpos.delegate.username === '') {\n                throw new Error('Voted account is not registered as delegate.');\n            }\n            const unlockIndex = sender.dpos.unlocking.findIndex(obj => obj.amount === unlock.amount &&\n                obj.delegateAddress.equals(unlock.delegateAddress) &&\n                obj.unvoteHeight === unlock.unvoteHeight);\n            if (unlockIndex < 0) {\n                throw new Error('Corresponding unlocking object not found.');\n            }\n            const currentHeight = store.chain.lastBlockHeaders[0].height + 1;\n            const minWaitingHeight = utils_1.getMinWaitingHeight(sender.address, delegate.address, unlock);\n            if (minWaitingHeight > currentHeight) {\n                throw new Error('Unlocking is not permitted as it is still within the waiting period.');\n            }\n            const minUnlockDelay = utils_1.getMinPunishedHeight(sender, delegate);\n            const lastPomHeight = delegate.dpos.delegate.pomHeights.length === 0\n                ? undefined\n                : Math.max(...delegate.dpos.delegate.pomHeights);\n            if (currentHeight >= this._unlockFixHeight &&\n                minUnlockDelay > currentHeight &&\n                lastPomHeight !== undefined &&\n                lastPomHeight < minWaitingHeight) {\n                throw new Error('Unlocking is not permitted as the delegate is currently being punished.');\n            }\n            if (currentHeight < this._unlockFixHeight && minUnlockDelay > currentHeight) {\n                throw new Error('Unlocking is not permitted as the delegate is currently being punished.');\n            }\n            sender.dpos.unlocking.splice(unlockIndex, 1);\n            await reducerHandler.invoke('token:credit', {\n                address: transaction.senderAddress,\n                amount: unlock.amount,\n            });\n            await store.account.set(sender.address, sender);\n        }\n    }\n}\nexports.UnlockTransactionAsset = UnlockTransactionAsset;\n//# sourceMappingURL=unlock_transaction_asset.js.map"]},"metadata":{},"sourceType":"script"}